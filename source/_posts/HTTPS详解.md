title: HTTPS详解
tags:
  - HTTP
  - HTTPS
categories:
  - 网络
date: 2019-04-11 17:40:00
---
### HTTP
tps: HTTP协议的笔记在另外一篇笔记中详细记载，这里对与HTTP协议的发展历史等不做阐述。
#### 什么是HTTP
> HTTP为超文本传输协议，是一个基于请求与响应，无状态，**应用层**的协议，常基于TCP/IP协议传输数据。互联网上应用最为广泛的一种网络协议,所有的WWW文件都必须遵守这个标准。设计HTTP的初衷是为了提供一种发布和接收HTML页面的方法。

#### HTTP的特点
- 无状态：对客户端没有存储状态，对事物处理没有记忆能力。比如登录网站的反复登录操作。
 - 一般可以使用cookies来记录用户的登录相关信息，设定过期时间等。
- 无连接：HTTP/1.1之前，由于无状态的特点，每次请求都需要经过TCP三次握手和四次挥手来重新建立和关闭TCP连接。如果是过多地请求，对于资源的利用和性能都有一定的影响。
 - 一般可以使用Connection: keep-alive来建立持久连接，避免每次都需要重新建立TCP连接。很多浏览器采用少量并行的TCP连接，其中每一个TCP连接都是持久连接的形式。
   - 但是对于存在代理服务器的，容易出现盲中继，哑巴代理的情况（代理服务器不认识Connection: keep-alive）。
 - HTTP/1.1中默认连接都是持久连接，不需要显示的指定keep-alive，在不希望建立持久连接 的请款下，请求首部中添加Connection: close来表示希望接收到响应后就断开连接。
- 基于请求和响应： 有客户端发情请求，服务端响应。
- 简单快速，灵活
- 使用明文，请求和响应不会对通信放进行确认，无法保证数据的完整性。
 - 针对HTTP明文传输，可以使用加密传输数据的方式。比如使用对阵密钥加密，MD5加密，base64加密等。
 
#### HTTP通信不加密的风险
- 窃听风险：第三方可以获取通信内容。
- 篡改风险：第三方可以修改通信内容。
- 冒充风险：第三方可以冒充他人身份参与通信。

### HTTPS
#### 什么是HTTPS
> HTTPS是一种通过计算机网络进行安全通信的传输协议，经由HTTP进行通信，利用SSL/TLS建立全信道，加密数据包。HTTPS使用的主要目的是提供对网站服务器的身份认证，同时保护交换数据的隐私与完整性。  
PS:TLS是传输层加密协议，前身是SSL协议，由网景公司1995年发布，有时候两者不区分。

#### HTTPS特点
基于HTTP协议，通过SSL加密，实现了数据加密，验证身份，数据完整性保护。
- 内容加密：采用混合加密（SSL），无法通过抓包的形式查看明文内容。第三方无法窃听
- 验证身份：通过HTTPS证书，客户端可以认证确定访问的是目标服务器。
 - 对于一些使用非对称加密的方式，很容易出现中间人攻击（伪造目标服务器，然后通过将自身的公钥发送给客户端用来加密的数据，然后使用私钥解密获取数据）。
- 保护数据的完整性：可以防止传输的内容被中间人冒充或者篡改。

##### SSL的混合加密
> 结合了对称加密和非对称加密技术。   
对称加密：客户端和服务端使用同一个密钥解密加密。   
非对称加密技术：分为公钥和私钥，客户端使用公钥加密数据传送给服务端，服务端使用私钥解密获取数据。   
混合加密中简单理解为：   
1.客户端使用对称密钥加密要传输的数据。   
2.客户端使用从服务端获取到的公钥加密上一步用于加密数据的对称密钥。   
3.服务端接收到客户端传送过来的加密过的数据和使用公钥加密的密钥。那么服务端使用私钥解密得到之前客户端加密数据使用的密钥，然后使用该密钥去解密获取数据。    
4.此时客户端和服务端都获取了用于加密数据的对称密钥，那么后面的数据传输，就直接使用该对称密钥加密传输。    
**注意：上述中说明的对称密钥的生成，实际上是通过了三个随机数按照约定的算法得出的密钥。具体的说明再后面握手阶段有详细的讲解说明。**

### HTTPS中证书验证
#### 非对称加密的隐患
之前说过混合加密主要使用了一个对称加密密钥和一对公钥和私钥。其中公钥和私钥是在服务端生成的，由服务端发送给客户端的，那么其中就有一个问题了，如果确保客户端获取的公钥就是目标服务器发送的，而不是中间服务器（中间人攻击）发送给你的呢？
##### 中间人攻击

![upload successful](/images/pasted-4.png)
如上图中所示，SSL加密中是使用公钥加密的对称密钥，同样也会被中间人截获到，所以需要使用方法确认客户端接收到的公钥是来自于目标服务器而不是其他服务器。HTTPS中使用**证书验证**来确认服务器的身份。
#### HTTPS证书
##### 证书的申请和内容
SSL证书一般向权威的第三方CA机构去请求颁发。申请之后会提供给你一个证书和私钥，私钥直接存在服务端，证书则发送给客户端，因为证书中有公钥。（申请的方法这里不做阐述）  
SSL证书中包含的内容：
- 服务器的域名，比如www.wjsummer.top
- 证书的过期时间
- 公钥
- 数字摘要生成的方法，比如MD5
- 使用CA机构公钥加密数字摘要后的一个证书编号。

![upload successful](/images/pasted-5.png)
##### 证书的验证
那么当服务端将证书返回给客户端后，客户端就可以验证证书的真实性，然后获取公钥。   
验证流程：
1. 客户端根据证书的信息，确认域名是否为请求的域名，是否过期等确认证书的有效性。
2. 客户端（比如浏览器）根据证书的颁发机构，选择对应机构的私钥去解密数字签名，获得数字摘要A。
3. 客户端根据证书上面的信息，和数字摘要生成的方法，计算生成数字摘要B。
4. 对比解密得到的数字摘要A和自己生成的数字摘要B是否一样。
5. 以上都没问题则确认了当前返回响应的服务器是目标服务器。

###### 未完成的
- 证书验证的图
- 整个流程原理图
- 四次握手详解，三个随机值生成对称密钥。
